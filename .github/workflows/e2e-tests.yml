name: E2E Tests

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'readme/**'
      - 'dockerfiles/**'
      - 'Notebooks/**'

  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'readme/**'
      - 'dockerfiles/**'
      - 'Notebooks/**'

  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'critical'
        type: choice
        options:
          - all
          - critical
          - smoke
          - fast

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            calibre \
            espeak-ng \
            libsndfile1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps

      - name: Run E2E tests
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'critical' }}"
          if [ "$TEST_SUITE" = "all" ]; then
            pytest tests/e2e/ -v --tb=short --maxfail=5
          elif [ "$TEST_SUITE" = "critical" ]; then
            pytest tests/e2e/ -m critical -v --tb=short
          elif [ "$TEST_SUITE" = "smoke" ]; then
            pytest tests/e2e/ -m smoke -v --tb=short
          elif [ "$TEST_SUITE" = "fast" ]; then
            pytest tests/e2e/ -m "not slow" -v --tb=short
          fi
        env:
          E2A_TEST_HOST: 127.0.0.1
          E2A_TEST_PORT: 7860
          CI: true

      - name: Generate test report
        if: always()
        run: |
          pytest tests/e2e/ --html=test-report.html --self-contained-html || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results-py${{ matrix.python-version }}
          path: |
            test-report.html
            test-results/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-screenshots-py${{ matrix.python-version }}
          path: test-results/screenshots/
          retention-days: 7

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const testReport = fs.existsSync('test-report.html');

            const comment = `## E2E Test Results (Python ${{ matrix.python-version }})

            **Status**: ${{ job.status }}

            ${testReport ? 'üìä [View detailed test report in artifacts]' : '‚ö†Ô∏è Test report not generated'}

            **Note**: These are RED phase tests - failures are expected as we identify production readiness issues.

            See the [Production Readiness Checklist](tests/PRODUCTION_READINESS.md) for details on required fixes.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-status-summary:
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "E2E Tests Status: ${{ needs.e2e-tests.result }}"

          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "‚úÖ All e2e tests passed!"
            echo "The application is production-ready."
          elif [ "${{ needs.e2e-tests.result }}" = "failure" ]; then
            echo "‚ùå Some e2e tests failed."
            echo "This is expected during RED phase of TDD."
            echo "See PRODUCTION_READINESS.md for required fixes."
            # Don't fail the workflow in RED phase
            exit 0
          else
            echo "‚ö†Ô∏è Tests were cancelled or skipped"
            exit 1
          fi
